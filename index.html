<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è–èª•ç¦®ç‰©å¤§ä½œæˆ°</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: linear-gradient(to bottom, #0f2027, #203a43, #2c5364); /* å†¬å¤œæ˜Ÿç©ºèƒŒæ™¯ */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            touch-action: none; /* é˜²æ­¢æ‰‹æ©Ÿä¸Šä¸‹æ»‘å‹•é é¢ */
        }

        #gameCanvas {
            display: block;
            margin: 0 auto;
        }

        /* UI è¦†è“‹å±¤ */
        #uiLayer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .hud {
            padding: 20px;
            color: white;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            display: flex;
            justify-content: space-between;
        }

        /* é–‹å§‹èˆ‡çµæŸç•«é¢ */
        #startScreen, #gameOverScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 10;
            pointer-events: auto;
            backdrop-filter: blur(5px);
        }

        h1 {
            font-size: 48px;
            margin-bottom: 10px;
            color: #ff4d4d; /* è–èª•ç´… */
            text-shadow: 3px 3px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff;
            text-align: center;
        }

        p {
            font-size: 18px;
            margin-bottom: 30px;
            text-align: center;
            line-height: 1.5;
            max-width: 80%;
        }

        .btn {
            padding: 15px 40px;
            font-size: 24px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: transform 0.2s, background 0.2s;
            font-weight: bold;
            border: 2px solid white;
        }

        .btn:hover {
            transform: scale(1.05);
            background: #218838;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .hidden {
            display: none !important;
        }

        .score-big {
            font-size: 60px;
            color: #ffd700;
            margin: 10px 0;
        }
    </style>
</head>
<body>

    <!-- éŠæˆ²ç•«å¸ƒ -->
    <canvas id="gameCanvas"></canvas>

    <!-- HUD æŠ¬é ­é¡¯ç¤ºå™¨ -->
    <div id="uiLayer">
        <div class="hud">
            <div id="scoreDisplay">åˆ†æ•¸: 0</div>
            <div id="livesDisplay">ç”Ÿå‘½: â¤ï¸â¤ï¸â¤ï¸</div>
        </div>
    </div>

    <!-- é–‹å§‹ç•«é¢ -->
    <div id="startScreen">
        <h1>ğŸ„ è–èª•ç¦®ç‰©å¤§ä½œæˆ° ğŸ„</h1>
        <p>æ§åˆ¶è–èª•è€äººæ¥ä½ç¦®ç‰© ğŸ<br>é¿é–‹ç…¤ç‚­ âš«<br>æ¥ä½é›ªèŠ± â„ï¸ å¯ä»¥è£œè¡€ï¼</p>
        <button class="btn" id="startBtn">é–‹å§‹éŠæˆ²</button>
    </div>

    <!-- éŠæˆ²çµæŸç•«é¢ -->
    <div id="gameOverScreen" class="hidden">
        <h1>ğŸ… éŠæˆ²çµæŸ ğŸ…</h1>
        <p>ä½ çš„æœ€çµ‚åˆ†æ•¸æ˜¯</p>
        <div class="score-big" id="finalScore">0</div>
        <button class="btn" id="restartBtn">å†ç©ä¸€æ¬¡</button>
    </div>

    <script>
        // --- éŠæˆ²è¨­å®š ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const startScreen = document.getElementById('startScreen');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const livesDisplay = document.getElementById('livesDisplay');
        const finalScoreDisplay = document.getElementById('finalScore');
        const startBtn = document.getElementById('startBtn');
        const restartBtn = document.getElementById('restartBtn');

        let animationId;
        let score = 0;
        let lives = 3;
        let gameRunning = false;
        let difficultyMultiplier = 1;
        let frameCount = 0;

        // éŸ³æ•ˆ Context
        let audioCtx;

        // éŠæˆ²ç‰©ä»¶
        const player = {
            x: 0,
            y: 0,
            width: 60,
            height: 60,
            speed: 10,
            emoji: 'ğŸ…'
        };

        let items = []; // æ‰è½ç‰©
        let particles = []; // ç‰¹æ•ˆç²’å­
        let bgSnow = []; // èƒŒæ™¯é›ªèŠ±

        // --- åˆå§‹åŒ–èˆ‡äº‹ä»¶ç›£è½ ---
        
        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            player.y = canvas.height - 100;
            player.x = canvas.width / 2;
            initBgSnow();
        }
        window.addEventListener('resize', resize);
        resize();

        // è¼¸å…¥æ§åˆ¶
        let keys = {};
        let touchX = null;

        window.addEventListener('keydown', (e) => keys[e.code] = true);
        window.addEventListener('keyup', (e) => keys[e.code] = false);
        
        // æ»‘é¼ /è§¸æ§æ§åˆ¶
        canvas.addEventListener('mousemove', (e) => {
            if(gameRunning) player.x = e.clientX;
        });
        
        canvas.addEventListener('touchmove', (e) => {
            if(gameRunning) {
                e.preventDefault();
                player.x = e.touches[0].clientX;
            }
        }, {passive: false});

        startBtn.addEventListener('click', startGame);
        restartBtn.addEventListener('click', startGame);

        // --- éŸ³æ•ˆç³»çµ± (ä½¿ç”¨ Web Audio API ç”Ÿæˆç°¡å–®éŸ³æ•ˆ) ---
        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function playSound(type) {
            if (!audioCtx) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();

            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            if (type === 'catch') {
                // æ¸…è„†çš„é«˜éŸ³ (éˆ´è²æ„Ÿ)
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.1);
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.1);
            } else if (type === 'heal') {
                // æŸ”å’Œçš„ä¸Šå‡éŸ³
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(400, audioCtx.currentTime);
                osc.frequency.linearRampToValueAtTime(600, audioCtx.currentTime + 0.3);
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.3);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.3);
            } else if (type === 'hit') {
                // ä½æ²‰çš„å™ªéŸ³
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 0.3);
                gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.3);
            }
        }

        // --- éŠæˆ²é‚è¼¯ ---

        function initBgSnow() {
            bgSnow = [];
            for(let i=0; i<50; i++) {
                bgSnow.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    radius: Math.random() * 2 + 1,
                    speed: Math.random() * 1 + 0.5
                });
            }
        }

        function spawnItem() {
            const rand = Math.random();
            let type = 'gift';
            let emoji = 'ğŸ';
            let speed = (3 + Math.random() * 3) * difficultyMultiplier;
            let scoreVal = 10;

            if (rand < 0.25) { // 25% æ©Ÿç‡æ˜¯ç…¤ç‚­
                type = 'coal';
                emoji = 'âš«';
                scoreVal = 0;
                speed *= 1.2; // ç…¤ç‚­æ‰æ¯”è¼ƒå¿«
            } else if (rand > 0.95) { // 5% æ©Ÿç‡æ˜¯æ„›å¿ƒé›ªèŠ±
                type = 'snow';
                emoji = 'â„ï¸';
                scoreVal = 5;
                speed *= 0.8; // é›ªèŠ±é£„æ¯”è¼ƒæ…¢
            } else {
                // éš¨æ©Ÿç¦®ç‰©é¡è‰²
                const gifts = ['ğŸ', 'ğŸ€', 'ğŸ§¸', 'ğŸ””'];
                emoji = gifts[Math.floor(Math.random() * gifts.length)];
            }

            items.push({
                x: Math.random() * (canvas.width - 40) + 20,
                y: -50,
                size: 30,
                type: type,
                emoji: emoji,
                speed: speed,
                scoreVal: scoreVal,
                angle: 0,
                spinSpeed: (Math.random() - 0.5) * 0.1
            });
        }

        function createParticles(x, y, color) {
            for(let i=0; i<10; i++) {
                particles.push({
                    x: x,
                    y: y,
                    vx: (Math.random() - 0.5) * 10,
                    vy: (Math.random() - 0.5) * 10,
                    life: 1,
                    color: color
                });
            }
        }

        function startGame() {
            initAudio();
            startScreen.classList.add('hidden');
            gameOverScreen.classList.add('hidden');
            
            score = 0;
            lives = 3;
            difficultyMultiplier = 1;
            items = [];
            particles = [];
            gameRunning = true;
            frameCount = 0;
            
            player.x = canvas.width / 2;
            updateUI();
            
            if(animationId) cancelAnimationFrame(animationId);
            loop();
        }

        function gameOver() {
            gameRunning = false;
            playSound('hit');
            finalScoreDisplay.textContent = score;
            gameOverScreen.classList.remove('hidden');
        }

        function updateUI() {
            scoreDisplay.textContent = `åˆ†æ•¸: ${score}`;
            let hearts = '';
            for(let i=0; i<lives; i++) hearts += 'â¤ï¸';
            livesDisplay.textContent = `ç”Ÿå‘½: ${hearts}`;
        }

        function update() {
            // é›£åº¦éš¨æ™‚é–“å¢åŠ 
            frameCount++;
            if (frameCount % 600 === 0) { // æ¯10ç§’å¢åŠ é›£åº¦
                difficultyMultiplier += 0.1;
            }

            // ç”¢ç”Ÿæ‰è½ç‰©
            if (frameCount % Math.max(20, Math.floor(60 / difficultyMultiplier)) === 0) {
                spawnItem();
            }

            // éµç›¤ç§»å‹•
            if (keys['ArrowLeft'] || keys['KeyA']) player.x -= player.speed;
            if (keys['ArrowRight'] || keys['KeyD']) player.x += player.speed;

            // é‚Šç•Œæª¢æŸ¥
            if (player.x < player.width/2) player.x = player.width/2;
            if (player.x > canvas.width - player.width/2) player.x = canvas.width - player.width/2;

            // æ›´æ–°èƒŒæ™¯é›ªèŠ±
            bgSnow.forEach(flake => {
                flake.y += flake.speed;
                if(flake.y > canvas.height) {
                    flake.y = -5;
                    flake.x = Math.random() * canvas.width;
                }
            });

            // æ›´æ–°æ‰è½ç‰©
            for (let i = items.length - 1; i >= 0; i--) {
                let item = items[i];
                item.y += item.speed;
                item.angle += item.spinSpeed;

                // ç¢°æ’æª¢æ¸¬ (è·é›¢åˆ¤å®š)
                const dx = item.x - player.x;
                const dy = item.y - (player.y - 10); // ç¨å¾®ä¿®æ­£ç¢°æ’ä¸­å¿ƒ
                const distance = Math.sqrt(dx*dx + dy*dy);

                if (distance < player.width/2 + item.size/2) {
                    // æ¥åˆ°äº†
                    if (item.type === 'coal') {
                        lives--;
                        playSound('hit');
                        createParticles(item.x, item.y, '#333');
                        if (lives <= 0) gameOver();
                    } else if (item.type === 'snow') {
                        if(lives < 3) lives++;
                        score += item.scoreVal;
                        playSound('heal');
                        createParticles(item.x, item.y, '#fff');
                    } else {
                        score += item.scoreVal;
                        playSound('catch');
                        createParticles(item.x, item.y, '#ffD700');
                    }
                    updateUI();
                    items.splice(i, 1);
                    continue;
                }

                // è¶…å‡ºåº•éƒ¨
                if (item.y > canvas.height + 50) {
                    items.splice(i, 1);
                }
            }

            // æ›´æ–°ç²’å­
            for (let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.life -= 0.05;
                if(p.life <= 0) particles.splice(i, 1);
            }
        }

        function draw() {
            // æ¸…ç©ºç•«å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // ç¹ªè£½èƒŒæ™¯é›ªèŠ±
            ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
            bgSnow.forEach(flake => {
                ctx.beginPath();
                ctx.arc(flake.x, flake.y, flake.radius, 0, Math.PI*2);
                ctx.fill();
            });

            // ç¹ªè£½ç©å®¶
            ctx.font = `${player.width}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            // åŠ ä¸Šé™°å½±
            ctx.shadowColor = 'rgba(0,0,0,0.5)';
            ctx.shadowBlur = 10;
            ctx.save();
            // ç§»å‹•æ™‚çš„å‚¾æ–œæ•ˆæœ
            let tilt = 0;
            if (keys['ArrowLeft']) tilt = -0.2;
            if (keys['ArrowRight']) tilt = 0.2;
            
            ctx.translate(player.x, player.y);
            ctx.rotate(tilt);
            ctx.fillText(player.emoji, 0, 0);
            ctx.restore();

            // ç¹ªè£½æ‰è½ç‰©
            items.forEach(item => {
                ctx.save();
                ctx.translate(item.x, item.y);
                ctx.rotate(item.angle);
                ctx.font = `${item.size}px Arial`;
                ctx.fillText(item.emoji, 0, 0);
                ctx.restore();
            });

            // ç¹ªè£½ç²’å­
            ctx.shadowBlur = 0;
            particles.forEach(p => {
                ctx.globalAlpha = p.life;
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(p.x, p.y, 5, 0, Math.PI*2);
                ctx.fill();
                ctx.globalAlpha = 1;
            });
        }

        function loop() {
            if (!gameRunning) return;
            update();
            draw();
            animationId = requestAnimationFrame(loop);
        }

    </script>
</body>
</html>
